@{
    ViewData["Title"] = "Flashcard Maker Manual";
    Layout = "~/Views/Shared/_HomeLayout.cshtml";
}
<html>
<head>
    <link rel="stylesheet" href="~/css/Global/Header.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/Flash_Card_Maker_Manual.css" asp-append-version="true" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rum+Raisin&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container1">
        <!-- Main Form for Saving Flashcards -->
        <form id="flashcard-form">
            <div class="title">
                <div class="title-text">CREATE NEW FLASHCARDS!</div>
                <!-- Save and Practice Buttons -->
                <div class="header-button">
                    <button type="button" class="button" onclick="submitForm()">
                        <img src="~/Assets/floppy 3.png" alt="Save Icon">
                        SAVE
                    </button>
                    <button type="button" class="button2" name="action" value="practice" onclick="practiceMode(event)">
                        <img src="/Assets/practice symbol 1.png" alt="Practice Icon">
                        PRACTICE
                    </button>
                </div>
            </div>
            <!-- Flashcard Title and Description -->
            <div class="form-1">
                <input type="text" id="flashcardTitle" name="flashcardTitle" class="form-control1" placeholder="Enter flashcard title..." required />
            </div>
            <div class="form-2">
                <textarea id="flashcardDescription" name="flashcardDescription" class="form-control" rows="4" placeholder="Enter flashcard description..." required></textarea>
            </div>
            <hr style="height: 3px; background-color: black; border: none; margin-top: 50px; margin-bottom: 50px;" />
            <!-- Quiz Container -->
            <div id="quiz-container">
                <div class="quiz-box" data-index="1">
                    <div class="quiz-box-top">
                        <div class="question-number">
                            <div class="question-number-text">1</div>
                        </div>
                        <div class="question-box">
                            <input type="text" name="questions[0].Question" placeholder="Enter question here..." required />
                        </div>
                        <div class="answer-box">
                            <input type="text" name="questions[0].Answer" placeholder="Enter answer here..." required />
                        </div>
                        <div class="image-upload-question">
                            <input type="file" name="questions[0].ImageFile" accept="image/*" onchange="previewImage(event, 0)" />
                            <img id="preview-0" src="" alt="Image Preview" style="display:none; max-width: 100px; max-height: 100px;" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="add-question-button">
                <button type="button" id="add-question-button">
                    <img src="~/Assets/FlashCardMakerManual/add symbol 2.png" alt="Add Icon">
                </button>
            </div>
        </form>
    </div>
    <script>
        document.getElementById('add-question-button').addEventListener('click', function() {
            const quizContainer = document.getElementById('quiz-container');
            const quizBoxes = document.querySelectorAll('.quiz-box');
            const newIndex = quizBoxes.length;

            const newQuizBox = document.createElement('div');
            newQuizBox.className = 'quiz-box';
            newQuizBox.setAttribute('data-index', newIndex + 1);
            newQuizBox.innerHTML = `
                <div class="quiz-box-top">
                    <div class="question-number">
                        <div class="question-number-text">${newIndex + 1}</div>
                    </div>
                    <div class="question-box">
                        <input type="text" name="questions[${newIndex}].Question" placeholder="Enter question here..." required />
                    </div>
                    <div class="answer-box">
                        <input type="text" name="questions[${newIndex}].Answer" placeholder="Enter answer here..." required />
                    </div>
                    <div class="image-upload-question">
                        <input type="file" name="questions[${newIndex}].ImageFile" accept="image/*" onchange="previewImage(event, ${newIndex})" />
                        <img id="preview-${newIndex}" src="" alt="Image Preview" style="display:none; max-width: 100px; max-height: 100px;" />
                    </div>
                </div>
            `;

            quizContainer.appendChild(newQuizBox);
        });

        function previewImage(event, index) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(`preview-${index}`);
                    img.src = e.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function practiceMode(event) {
            event.preventDefault(); // Prevent the form from submitting
            const form = document.getElementById('flashcard-form');
            const formData = new FormData(form);

            // Collect data from the form
            const data = {
                title: formData.get('flashcardTitle'),
                description: formData.get('flashcardDescription'),
                questions: []
            };

            const questions = document.querySelectorAll('.quiz-box');
            const promises = [];

            questions.forEach((questionBox, index) => {
                const question = formData.get(`questions[${index}].Question`);
                const answer = formData.get(`questions[${index}].Answer`);
                const imageFile = formData.get(`questions[${index}].ImageFile`);

                const questionData = { questionText: question, answerText: answer, imageQuestionPath: null };

                if (imageFile) {
                    const reader = new FileReader();
                    const promise = new Promise((resolve, reject) => {
                        reader.onload = function(event) {
                            questionData.imageQuestionPath = event.target.result;
                            resolve();
                        };
                        reader.onerror = function(event) {
                            reject(event);
                        };
                        reader.readAsDataURL(imageFile);
                    });
                    promises.push(promise);
                }

                data.questions.push(questionData);
            });

            Promise.all(promises).then(() => {
                // Store data in localStorage
                localStorage.setItem('flashcardData', JSON.stringify(data));

                // Redirect to practice page
                window.location.href = '/FlashCards/Practice';
            }).catch(error => {
                console.error('Error processing images:', error);
                alert('Failed to process images.');
            });
        }

        function submitForm() {
            const form = document.getElementById('flashcard-form');
            const formData = new FormData(form);

            // Collect data from the form
            const data = {
                title: formData.get('flashcardTitle'),
                description: formData.get('flashcardDescription'),
                questions: []
            };

            const questions = document.querySelectorAll('.quiz-box');
            const savedData = JSON.parse(localStorage.getItem('flashcardData')) ?? null;
            questions.forEach((questionBox, index) => {
                const question = formData.get(`questions[${index}].Question`);
                const answer = formData.get(`questions[${index}].Answer`);
                let imageBase64 = null;

                if (savedData && savedData.questions && savedData.questions[index]) {
                    imageBase64 = savedData.questions[index].imageQuestionPath;
                }

                if (imageBase64) {
                    const byteString = atob(imageBase64.split(',')[1]);
                    const mimeString = imageBase64.split(',')[0].split(':')[1].split(';')[0];
                    const ab = new ArrayBuffer(byteString.length);
                    const ia = new Uint8Array(ab);
                    for (let i = 0; i < byteString.length; i++) {
                        ia[i] = byteString.charCodeAt(i);
                    }
                    const blob = new Blob([ab], { type: mimeString });
                    formData.append(`questions[${index}].ImageFile`, blob, `image-${index}.png`);
                } else {
                    const imageFile = formData.get(`questions[${index}].ImageFile`);
                    if (imageFile) {
                        formData.append(`questions[${index}].ImageFile`, imageFile);
                    }
                }
                data.questions.push({ questionText: question, answerText: answer, imageQuestionPath: null });
            });

            // Append the JSON data to FormData
            formData.append('jsonData', JSON.stringify(data));

            // Send the form data with fetch
            fetch('/FlashCards/SaveFlashcard', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    localStorage.removeItem("flashcardData")
                    form.reset();

                    alert('Flashcard saved successfully!');
                    window.location.reload()
                    // window.location.href = '/Home/Index'; // Redirect to index page
                } else {
                    alert('Failed to save flashcard.');
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('Failed to save flashcard.');
            });
        }

        document.querySelector('button[name="action"][value="practice"]').addEventListener('click', practiceMode);

        // Populate form with data from localStorage if available
        window.onload = function() {
            const flashcardData = JSON.parse(localStorage.getItem('flashcardData'));
            if (flashcardData) {
                document.getElementById('flashcardTitle').value = flashcardData.title;
                document.getElementById('flashcardDescription').value = flashcardData.description;

                flashcardData.questions.forEach((questionData, index) => {
                    if (index > 0) {
                        document.getElementById('add-question-button').click();
                    }
                    document.querySelector(`input[name="questions[${index}].Question"]`).value = questionData.questionText;
                    document.querySelector(`input[name="questions[${index}].Answer"]`).value = questionData.answerText;
                    if (questionData.imageQuestionPath) {
                        const img = document.getElementById(`preview-${index}`);
                        img.src = questionData.imageQuestionPath;
                        img.style.display = 'block';
                    }
                });
            }
        };
    </script>
</body>
</html>